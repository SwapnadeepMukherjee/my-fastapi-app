name: Deploy to Amazon ECR

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: ${{ vars.AWS_REGION }}                   # "us-east-1"
  ECR_REPOSITORY: my-fastapi-app                       # Your repo name
  IMAGE_TAG: ${{ github.sha }}                         # Unique commit hash

permissions:
  id-token: write   # REQUIRED for requesting the OIDC JWT
  contents: read    # Required for actions/checkout

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    # 1. Check out your code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Authenticate to AWS using OIDC (No keys!)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
        aws-region: ${{ env.AWS_REGION }}

    # 3. Log into Amazon ECR
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # 4. Build, tag, and push image to Amazon ECR
    - name: Build and push Docker image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        # Build the image with two tags: Unique SHA and Latest
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:latest .
        
        # Push both tags
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "::notice::Image pushed successfully to $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
